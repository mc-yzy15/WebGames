name: Release ZOM Package

on:
  push:
    branches: 
      - 'zom'
    paths:
      - 'src/**'
      - '.github/workflows/release-zom.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup PowerShell
      shell: powershell
      run: |
        $ErrorActionPreference = 'Stop'
        Write-Host "PowerShell version: $($PSVersionTable.PSVersion)"
        
    - name: Create Release Directory
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "release"
        
    - name: Build ZOM Package
      shell: powershell
      run: |
        $ErrorActionPreference = 'Stop'
        
        # è·å–æ—¶é—´æˆ³
        $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
        Write-Host "Build timestamp: $timestamp"
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        $tempDir = "temp_zom_build"
        New-Item -ItemType Directory -Force -Path $tempDir
        
        # å¤åˆ¶menuç›®å½•ä¸‹çš„æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
        Copy-Item -Path "menu\*" -Destination $tempDir -Recurse -Force
        
        # åˆ›å»ºZOMåŒ… (ZIPæ ¼å¼)
        $zomFile = "release\WebGamesMenu_$timestamp.zom"
        Compress-Archive -Path "$tempDir\*" -DestinationPath $zomFile -Force
        
        Write-Host "ZOM package created: $zomFile"
        
        # æ¸…ç†ä¸´æ—¶ç›®å½•
        Remove-Item -Path $tempDir -Recurse -Force
        
        # è¾“å‡ºæ–‡ä»¶åä¾›åç»­æ­¥éª¤ä½¿ç”¨
        echo "ZOM_FILE=WebGamesMenu_$timestamp.zom" >> $env:GITHUB_ENV
        echo "TIMESTAMP=$timestamp" >> $env:GITHUB_ENV
        
    - name: Get Version Info
      shell: powershell
      run: |
        $version = (Get-Content "menu\application.json" | ConvertFrom-Json).version
        echo "VERSION=$version" >> $env:GITHUB_ENV
        Write-Host "Package version: $version"
        
    - name: Delete Existing Pre-release
      shell: powershell
      run: |
        $ErrorActionPreference = 'SilentlyContinue'
        
        # è·å–ç°æœ‰çš„InstantReleaseé¢„å‘å¸ƒç‰ˆæœ¬
        $releases = gh release list --limit 100 | Select-String "InstantRelease"
        foreach ($release in $releases) {
          $tag = ($release -split "\s+")[0]
          Write-Host "Deleting existing pre-release: $tag"
          gh release delete $tag --yes
        }
      env:
        GH_TOKEN: ${{ secrets.TOKEN }}
        
    - name: Create Release
      shell: powershell
      run: |
        $ErrorActionPreference = 'Stop'
        
        $tagName = "InstantRelease_${{ env.TIMESTAMP }}"
        $releaseName = "InstantRelease ${{ env.TIMESTAMP }}"
        $version = "${{ env.VERSION }}"
        $zomFile = "${{ env.ZOM_FILE }}"
        
        # åˆ›å»ºå‘å¸ƒè¯´æ˜
        $notes = @"
# WebGames Menu v$version

## è‡ªåŠ¨æ„å»ºå‘å¸ƒ

æ­¤ç‰ˆæœ¬ç”± CI/CD è‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒã€‚

### æ„å»ºä¿¡æ¯
- **ç‰ˆæœ¬**: $version
- **æ„å»ºæ—¶é—´**: ${{ env.TIMESTAMP }}
- **æäº¤**: ${{ github.sha }}

### æ–‡ä»¶è¯´æ˜
- `$zomFile`: ZerOS ç¨‹åºå®‰è£…åŒ… (ZOMæ ¼å¼)

### å®‰è£…æ–¹æ³•
åœ¨ ZerOS ç³»ç»Ÿä¸­ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š
```bash
zominstall D:/path/to/$zomFile
```

### åŒ…å«çš„æ¸¸æˆ
- ğŸ”¢ 2048 - æ•°å­—ç›Šæ™ºæ¸¸æˆ
- ğŸ’£ æ‰«é›· - ç»å…¸æ‰«é›·æ¸¸æˆ
- ğŸ è´ªåƒè›‡ - ç»å…¸è´ªåƒè›‡æ¸¸æˆ
- ğŸ“ çŒœå•è¯ - çŒœå•è¯æ¸¸æˆ

---
âš ï¸ è¿™æ˜¯ä¸€ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬ (Pre-release)ï¼Œå¯èƒ½åŒ…å«æœªæµ‹è¯•çš„åŠŸèƒ½ã€‚
"@

        # åˆ›å»ºé¢„å‘å¸ƒç‰ˆæœ¬
        gh release create $tagName `
          --title "$releaseName" `
          --notes "$notes" `
          --prerelease `
          "release\$zomFile"
          
        Write-Host "Release created successfully: $tagName"
      env:
        GH_TOKEN: ${{ secrets.TOKEN }}
