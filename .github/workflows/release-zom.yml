name: Release ZOM Package

on:
  push:
    branches: [zom]
    paths:
      - "release/**"
      - ".github/workflows/release-zom.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: zom

      - name: Setup PowerShell
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          Write-Host "PowerShell version: $($PSVersionTable.PSVersion)"

      - name: Create Release Directory
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "release"

      - name: Build ZOM Package
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'

          # è·å–æ—¶é—´æˆ³
          $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
          Write-Host "Build timestamp: $timestamp"

          # åˆ›å»ºä¸´æ—¶ç›®å½•
          $tempDir = "temp_zom_build"
          New-Item -ItemType Directory -Force -Path $tempDir

          # å¤åˆ¶ release ç›®å½•ä¸‹çš„æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
          Copy-Item -Path "release\*" -Destination $tempDir -Recurse -Force

          # åˆ›å»º ZOM åŒ… (ZIP æ ¼å¼)
          $zomFile = "release\WebGamesMenu_$timestamp.zom"
          Compress-Archive -Path "$tempDir\*" -DestinationPath $zomFile -Force

          Write-Host "ZOM package created: $zomFile"

          # æ¸…ç†ä¸´æ—¶ç›®å½•
          Remove-Item -Path $tempDir -Recurse -Force

          # è¾“å‡ºæ–‡ä»¶åä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "ZOM_FILE=WebGamesMenu_$timestamp.zom" >> $env:GITHUB_ENV
          echo "TIMESTAMP=$timestamp" >> $env:GITHUB_ENV

      - name: Get Version Info
        shell: powershell
        run: |
          $version = (Get-Content "src\application.json" | ConvertFrom-Json).version
          echo "VERSION=$version" >> $env:GITHUB_ENV
          Write-Host "Package version: $version"

      - name: Delete Existing Pre-release
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}
        run: |
          $ErrorActionPreference = 'SilentlyContinue'

          # è·å–ç°æœ‰çš„ InstantRelease é¢„å‘å¸ƒç‰ˆæœ¬
          $releases = gh release list --limit 100 | Select-String "InstantRelease"
          foreach ($release in $releases) {
            $tag = ($release -split "\s+")[0]
            Write-Host "Deleting existing pre-release: $tag"
            gh release delete $tag --yes
          }

      - name: Create Release
        shell: powershell
        env:
          GH_TOKEN: ${{ secrets.TOKEN }}
        run: |
          $ErrorActionPreference = 'Stop'

          $tagName = "InstantRelease_${{ env.TIMESTAMP }}"
          $releaseName = "InstantRelease ${{ env.TIMESTAMP }}"
          $version = "${{ env.VERSION }}"
          $zomFile = "release\${{ env.ZOM_FILE }}"

          # æ„å»ºå‘å¸ƒè¯´æ˜
          $notes = "# WebGames Menu v$version`n`n## è‡ªåŠ¨æ„å»ºå‘å¸ƒ`n`næ­¤ç‰ˆæœ¬ç”± CI/CD è‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒã€‚`n`n### æ„å»ºä¿¡æ¯`n- **ç‰ˆæœ¬**: $version`n- **æ„å»ºæ—¶é—´**: ${{ env.TIMESTAMP }}`n- **æäº¤**: ${{ github.sha }}`n`n### æ–‡ä»¶è¯´æ˜`n- `$zomFile`: ZerOS ç¨‹åºå®‰è£…åŒ… (ZOM æ ¼å¼)`n`n### åŒ…å«çš„æ¸¸æˆ`n- ğŸ”¢ 2048 - æ•°å­—ç›Šæ™ºæ¸¸æˆ`n- ğŸ’£ æ‰«é›· - ç»å…¸æ‰«é›·æ¸¸æˆ`n- ğŸ è´ªåƒè›‡ - ç»å…¸è´ªåƒè›‡æ¸¸æˆ`n- ğŸ“ çŒœå•è¯ - çŒœå•è¯æ¸¸æˆ`n- ğŸ€„ çŒœå­— - ä¸­æ–‡çŒœå­—æ¸¸æˆ`n`n---`nâš ï¸ è¿™æ˜¯ä¸€ä¸ªé¢„å‘å¸ƒç‰ˆæœ¬ (Pre-release)ï¼Œå¯èƒ½åŒ…å«æœªæµ‹è¯•çš„åŠŸèƒ½ã€‚"

          gh release create $tagName `
            --title "$releaseName" `
            --notes "$notes" `
            --prerelease `
            "$zomFile"
